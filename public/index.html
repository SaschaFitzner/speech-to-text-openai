<!DOCTYPE html>
<html>
<head>
    <title>Audio Recorder</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <h1>Audio Recorder</h1>
    <div id="controls">
        <div>
            <button id="record">Start</button>
            <button id="cancel">Cancel</button>
        </div>
        <button id="copy">Copy Text</button>
    </div>
    <textarea id="transcription"></textarea>

    <script>
        const recordButton = document.getElementById('record');
        const cancelButton = document.getElementById('cancel');
        const transcriptionTextArea = document.getElementById('transcription');
        const copyButton = document.getElementById('copy');
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let isCancelled = false;

        recordButton.addEventListener('click', function() {
            if (isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                audioChunks = [];
                recordButton.innerText = 'Start';
                recordButton.classList.remove('recording');
                isRecording = false;
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        isRecording = true;
                        recordButton.innerText = '\uD83D\uDD0A Stop'; // Unicode-Mikrofonsymbol und Text "Stop"
                        recordButton.classList.add('recording');

                        mediaRecorder.addEventListener('dataavailable', function(event) {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener('stop', function() {
                            if (isCancelled) {
                                audioChunks = [];
                                isCancelled = false;
                            } else {
                                const audioBlob = new Blob(audioChunks, { 'type' : 'audio/wav; codecs=0' });
                                sendAudioToServer(audioBlob);
                            }
                        });
                    })
                    .catch(err => console.error('getUserMedia failed:', err));
            }
        });

        cancelButton.addEventListener('click', function() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                audioChunks = [];
                recordButton.innerText = 'Start';
                isRecording = false;
                isCancelled = true;
            }
        });

        copyButton.addEventListener('click', function() {
            transcriptionTextArea.select();
            document.execCommand('copy');
        });

        function sendAudioToServer(blob) {
            let fd = new FormData();
            fd.append('audio', blob);
            fetch('http://localhost:3000/transcribe', {
                method: 'POST',
                body: fd
            })
            .then(response => response.text())
            .then(data => {
                transcriptionTextArea.value = data;
            })
            .catch(err => console.error('Error:', err));
        }
    </script>
</body>
</html>